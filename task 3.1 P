#include <Wire.h>
#include <BH1750.h>
#include <WiFiNINA.h>
#include <ArduinoHttpClient.h>

BH1750 lightMeter;

// ====== USER CONFIG ======
const char* ssid     = "JASMEET 2330";       // your WiFi name
const char* password = "240k}1S9";   // your WiFi password
const char* server   = "maker.ifttt.com";      // IFTTT Webhook server
String eventName     = "terrarium_sunlight_start";          // must match your IFTTT applet
String IFTTT_Key = "jqdZbtB0_oKuUUGO903heOINqj_6I9fTd9kVLNWdVAs";  // from IFTTT Webhooks

// =========================

WiFiClient wifi;
HttpClient client = HttpClient(wifi, server, 80);

void setup() {
  Serial.begin(9600);

  // Start WiFi
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  while (WiFi.begin(ssid, password) != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nConnected to WiFi!");

  // Start I2C + BH1750
  Wire.begin();
  if (lightMeter.begin(BH1750::CONTINUOUS_HIGH_RES_MODE)) {
    Serial.println("BH1750 ready");
  } else {
    Serial.println("Error initializing BH1750!");
    while (1);
  }
}

void loop() {
  float lux = lightMeter.readLightLevel();
  Serial.print("Light Level: ");
  Serial.print(lux);
  Serial.println(" lx");

  // Build IFTTT URL
  String url = "/trigger/" + eventName + "/with/key/" + IFTTT_Key;

  // Build JSON payload
  String payload = "{\"value1\":\"" + String(lux) + "\"}";

  // Send HTTP POST
  client.beginRequest();
  client.post(url);
  client.sendHeader("Content-Type", "application/json");
  client.sendHeader("Content-Length", payload.length());
  client.beginBody();
  client.print(payload);
  client.endRequest();

  // Get response
  int statusCode = client.responseStatusCode();
  String response = client.responseBody();

  Serial.print("Status code: ");
  Serial.println(statusCode);
  Serial.print("Response: ");
  Serial.println(response);

  delay(10000); // send every 10 seconds
}
